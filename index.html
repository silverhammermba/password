<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Password Generator</title>

		<style type="text/css">
#password {
	font-family: monospace;
	height: auto;
}
#chars label {
	font-family: monospace;
	border: 1px solid gray;
	border-radius: 4px;
	padding: 0 4px;
}
#chars label.off {
	background-color: lightgrey;
}
		</style>
	</head>
	<body>
		<h1>Generate an ASCII password</h1>
		<form>
			<!-- TODO add explanation why editing this clears entropy -->
			<input id="password" type="text" placeholder="Password" oninput="setEntropy(0)">
			<button type="button" onclick="generate_password()">Generate</button>
		</form>
		<form>
			<div>
				<label>Length <input id="length" type="number" min="1" step="1" value="12" oninput="len2ent()"></label>
				<label>Bits of entropy <input id="entropy" type="number" min="1" step="1" oninput="ent2len()"></label>
			</div>
			<h2>Allowed character classes</h2>
			<div id="classes">
				<div><label><input type="checkbox" value="numbers" onclick="classClicked(this)" checked> Numbers (0&ndash;9)</label></div>
				<div><label><input type="checkbox" value="lowercase" onclick="classClicked(this)" checked> Lowercase (a&ndash;z)</label></div>
				<div><label><input type="checkbox" value="uppercase" onclick="classClicked(this)" checked> Uppercase (A&ndash;Z)</label></div>
				<div><label><input type="checkbox" value="other" onclick="classClicked(this)" checked> Other (!, #, ~, etc.)</label></div>
			</div>
		</form>
		<!-- add a general blurb about what this all means and how/why to trust this page -->
		<div id="chars">
			<h2>Allowed characters</h2>
		</div>

		<script>
'use strict';

// minimum and maximum (printable) ASCII characters
var minmax = " ~";
var mincode = minmax.codePointAt(0);
var maxcode = minmax.codePointAt(1);

// simple categories of character code points
var classes = {
	"numbers": [[48, 57]],
	"lowercase": [[97, 122]],
	"uppercase": [[65, 90]],
	"other": [[32, 47], [58, 64], [91, 96], [123, 126]]
}

// flags indicating which characters are allowed/disallowed
var allowed = [];
for (var i = mincode; i <= maxcode; ++i) {
	allowed[i - mincode] = true;
}
// list of just allowed characters TODO remove entirely?
var available = [];

function getLength() {
	return parseInt(document.getElementById('length').value, 10);
}

function setLength(l) {
	l = Math.max(1, Math.round(l));
	document.getElementById('length').value = l;
	return l;
}

function getEntropy() {
	return parseInt(document.getElementById('entropy').value, 10);
}

function setEntropy(e) {
	e = Math.max(1, Math.floor(e));
	document.getElementById('entropy').value = e;
	return e;
	// 70 is okay...
	// 80 is good
	// 90 is strong
	// 128 industrial strength
	// 256
}

// rebuild list of allowed characters
function rebuildAvailable() {
	available = [];
	for (var i = 0; i < allowed.length; ++i) {
		if (allowed[i]) available.push(i + mincode);
	}
	len2ent();
}
rebuildAvailable();

// get string representation of a code point (to make space visible)
function codeStr(i) {
	var str = String.fromCodePoint(i);
	if (str === " ") return "␠";
	return str;
}

// random integer in [min, max)
function getRandomInt(min, max) {
	min = Math.ceil(min);
	max = Math.floor(max);
	return Math.floor(Math.random() * (max - min)) + min;
}

// set the entropy from the current length
function len2ent() {
	var len = setLength(getLength());

	var ent = Math.log(Math.pow(available.length, len)) / Math.log(2);
	setEntropy(ent);
}

function ent2len() {
	var ent = setEntropy(getEntropy());

	var len = Math.ceil(Math.log(Math.pow(2, ent)) / Math.log(available.length));
	// TODO this doesn't work when decreasing entropy by 1, it should keep decreasing until password decreases by 1
	// TODO this also doesn't work when typing in. it instantly changes numbers to something else. Maybe a delay whenever it changes?
	setLength(len);
	len2ent();
}

// return a random ASCII password
function generate_password() {
	if (available.length === 0)
	{
		setEntropy(0);
		return "";
	}

	var length = Math.max(1, Math.round(getLength()));

	var ent = Math.log(Math.pow(available.length, length)) / Math.log(2);
	setEntropy(ent);

	var pass = [];
	for (var i = 0; i < length; ++i) {
		pass[i] = available[getRandomInt(0, available.length)];
	}

	document.getElementById("password").value = String.fromCodePoint.apply(this, pass);
}

function setAllowed(codePoint, isAllowed) {
	allowed[codePoint - mincode] = isAllowed;
	var checkbox = document.getElementById('char' + codePoint);
	checkbox.checked = isAllowed;
	checkbox.parentElement.classList.toggle('off', !isAllowed);
}

function letterClicked(checkbox) {
	setAllowed(parseInt(checkbox.value, 10), checkbox.checked);
	rebuildAvailable();
}

function classClicked(checkbox) {
	var ranges = classes[checkbox.value];
	var value = checkbox.checked;

	for (var i = 0; i < ranges.length; ++i) {
		for (var j = ranges[i][0]; j <= ranges[i][1]; ++j) {
			setAllowed(j, value);
		}
	}
	rebuildAvailable();
}

// add a checkbox for each character
for (var i = mincode; i <= maxcode; ++i) {
	var template = document.createElement('template');
	template.innerHTML = '<label><input type="checkbox" id="char' + i + '" value="' + i + '" onclick="letterClicked(this)" checked>' + codeStr(i) + '</label> ';
	document.getElementById('chars').append(template.content.firstChild);
}
		</script>
	</body>
</html>
